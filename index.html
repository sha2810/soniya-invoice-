<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Soniya Dresses - Billing System (Supabase)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Modern Design System --- */
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #f59e0b;
            --accent-color: #ec4899;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-dark: #0f172a;
            
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --text-light: #f8fafc;
            
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
        }

        /* --- Dark Mode Variables --- */
body.dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-dark: #020617;
            
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --text-light: #0f172a;
            
            --border-color: #334155;
            --border-light: #475569;
        }

        /* --- Base Styles --- */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* --- Container & Layout --- */
        .container { 
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* --- Header Design --- */
        .header { 
            background: var(--bg-primary);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-2xl);
            padding: 2.5rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--secondary-color));
        }

        .header h1 { 
            color: var(--primary-color);
            font-size: 3rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p { 
            color: var(--text-secondary);
            font-size: 1.125rem;
            font-weight: 400;
        }

        /* --- Vertical Sidebar Layout --- */
        .app-layout {
            display: flex;
            min-height: calc(100vh - 200px);
            gap: 2rem;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-light);
            position: sticky;
            top: 2rem;
            height: fit-content;
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--secondary-color));
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
        }

        .main-content {
            flex: 1;
            min-width: 0;
        }

        /* --- Vertical Navigation Tabs --- */
        .nav-tabs { 
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }

        .sidebar-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .sidebar-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
            font-weight: 600;
        }

        .sidebar-toggle {
            display: none;
            background: var(--primary-color);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        @media (max-width: 1024px) {
            .sidebar-toggle {
                display: block;
            }
            
            .sidebar {
                display: none;
            }
            
            .sidebar.show {
                display: block;
            }
        }

        .nav-tab { 
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 1rem 1.25rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-secondary);
            font-size: 0.875rem;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            justify-content: flex-start;
            text-align: left;
        }

        .nav-icon {
            font-size: 1.125rem;
            transition: transform 0.3s ease;
        }

        .nav-text {
            font-weight: 500;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab:hover, .nav-tab.active { 
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--text-light);
            transform: translateX(8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
            padding-left: 1.5rem;
        }

        .nav-tab.active {
            position: relative;
        }

        .nav-tab.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .nav-tab:hover .nav-icon,
        .nav-tab.active .nav-icon {
            transform: scale(1.1) rotate(5deg);
        }

        /* --- Tab Content --- */
        .tab-content { 
            display: none;
            background: var(--bg-primary);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-2xl);
            padding: 2rem;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-light);
            animation: slideUp 0.4s ease-out;
        }

        .tab-content.active { 
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Typography --- */
        h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            position: relative;
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 0;
            width: 3rem;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: var(--radius-sm);
        }

        h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        /* --- Form Elements --- */
        .form-group { 
            margin-bottom: 1.5rem; 
        }

        .form-row { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        label { 
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input, select, textarea { 
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }

        input:focus, select:focus, textarea:focus { 
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }

        /* --- Buttons --- */
        .btn { 
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--text-light);
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: var(--radius-xl);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0.25rem;
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary { 
            background: linear-gradient(135deg, var(--secondary-color), #d97706);
            color: var(--text-light);
        }

        .btn-danger { 
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: var(--text-light);
        }

        .btn-success { 
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: var(--text-light);
        }

        .btn-info { 
            background: linear-gradient(135deg, var(--info-color), #2563eb);
            color: var(--text-light);
        }

        /* --- Cards & Grids --- */
        .product-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .product-card { 
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .product-card:hover::before {
            transform: scaleX(1);
        }

        .product-card img { 
            max-width: 100%;
            height: auto;
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .product-card:hover img {
            transform: scale(1.05);
        }

        .product-card:hover { 
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        /* --- Statistics Cards --- */
        .stats-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card { 
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--text-light);
            padding: 2rem 1.5rem;
            border-radius: var(--radius-xl);
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, var(--secondary-color), #d97706);
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }

        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, var(--accent-color), #be185d);
        }

        .stat-card:nth-child(5) {
            background: linear-gradient(135deg, var(--info-color), #2563eb);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transition: all 0.3s ease;
        }

        .stat-card:hover::before {
            transform: scale(1.5);
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }

        .stat-number { 
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-family: 'Poppins', sans-serif;
        }

        /* --- Tables & Lists --- */
        .invoice-item, .expense-item { 
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
            transition: all 0.3s ease;
            border-radius: var(--radius-md);
            margin-bottom: 0.25rem;
        }

        .invoice-item:first-child, .expense-item:first-child {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--text-light);
            font-weight: 600;
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
        }

        .invoice-item:hover, .expense-item:hover {
            background-color: var(--bg-secondary);
        }

        .invoice-total { 
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--text-light);
            padding: 1.5rem;
            border-radius: var(--radius-xl);
            margin-top: 1.5rem;
            text-align: right;
            box-shadow: var(--shadow-lg);
        }

        /* --- Search Bar --- */
        .search-bar { 
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-bar input { 
            padding-left: 3rem;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-xl);
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }

        .search-bar:hover input {
            border-color: var(--primary-color);
        }

        .search-icon { 
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.125rem;
        }

        /* --- Modal --- */
        .modal { 
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content { 
            background: var(--bg-primary);
            margin: 5% auto;
            padding: 2rem;
            border-radius: var(--radius-2xl);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-light);
        }

        .close { 
            color: var(--text-muted);
            float: right;
            font-size: 1.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close:hover { 
            color: var(--text-primary);
        }

        /* --- Dark Mode Toggle --- */
        #darkModeToggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: linear-gradient(135deg, var(--secondary-color), #d97706);
            border: none;
            color: var(--text-light);
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-xl);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        #darkModeToggle:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* --- Responsive Design --- */
        @media (max-width: 1024px) {
            .app-layout {
                flex-direction: column;
                gap: 1rem;
            }
            
            .sidebar {
                width: 100%;
                position: relative;
                top: 0;
            }
            
            .nav-tabs {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-tab {
                width: auto;
                min-width: 140px;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                padding: 2rem 1.5rem;
            }
            
            .header h1 {
                font-size: 2.25rem;
            }
            
            .nav-tabs { 
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .nav-tab { 
                width: 100%;
                text-align: center;
            }
            
            .form-row { 
                grid-template-columns: 1fr;
            }
            
            .invoice-item, .expense-item { 
                grid-template-columns: 1fr;
                gap: 0.5rem;
                text-align: center;
            }
            
            .product-grid { 
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }

        /* --- Print Styles --- */
        .print-invoice { 
            background: white;
            padding: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            line-height: 1.4;
            max-width: 300px;
            margin: 0 auto;
        }

        .print-header { 
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }

        .print-row { 
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .print-total { 
            border-top: 2px solid #000;
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            font-weight: bold;
        }

        /* --- Additional Utility Classes --- */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-5 { margin-bottom: 1.25rem; }
        .mb-6 { margin-bottom: 1.5rem; }

        /* --- Glassmorphism & Advanced Effects --- */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- Gradient Borders --- */
        .gradient-border {
            position: relative;
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            padding: 2px;
        }

        .gradient-border::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color), var(--secondary-color));
            border-radius: var(--radius-xl);
            z-index: -1;
        }

        /* --- Micro-interactions --- */
        .micro-interaction {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .micro-interaction:hover {
            transform: scale(1.02);
        }

        /* --- Skeleton Loading --- */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* --- Loading States --- */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* --- Dashboard Enhancements --- */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .quick-action-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-action-btn:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .quick-action-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        /* --- Progress Indicators --- */
        .progress-ring {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 4;
            stroke-linecap: round;
        }

        .progress-ring .bg {
            stroke: var(--border-color);
        }

        .progress-ring .progress {
            stroke: var(--primary-color);
            stroke-dasharray: 157;
            stroke-dashoffset: 157;
            transition: stroke-dashoffset 0.5s ease;
        }

        /* --- Status Badges --- */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-success { background: var(--success-color); color: white; }
        .status-warning { background: var(--warning-color); color: white; }
        .status-danger { background: var(--danger-color); color: white; }
        .status-info { background: var(--info-color); color: white; }

        /* --- Trend Indicators --- */
        .trend-arrow {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 600;
        }

        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }
        .trend-neutral { color: var(--text-muted); }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Enhanced Form Design --- */
        .form-group-enhanced {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .floating-label {
            position: absolute;
            top: 1rem;
            left: 1rem;
            color: var(--text-muted);
            transition: all 0.3s ease;
            pointer-events: none;
            background: var(--bg-primary);
            padding: 0 0.25rem;
            font-size: 0.875rem;
        }

        .form-group-enhanced input:focus + .floating-label,
        .form-group-enhanced input:not(:placeholder-shown) + .floating-label {
            top: -0.5rem;
            left: 0.75rem;
            font-size: 0.75rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .input-group {
            display: flex;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .input-group:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .input-group input {
            border: none;
            border-radius: 0;
            flex: 1;
        }

        .input-group .input-addon {
            background: var(--bg-secondary);
            padding: 0.875rem 1rem;
            border-left: 1px solid var(--border-color);
            color: var(--text-muted);
            display: flex;
            align-items: center;
        }

        /* --- Form Validation States --- */
        .form-group-enhanced.valid input {
            border-color: var(--success-color);
        }

        .form-group-enhanced.invalid input {
            border-color: var(--danger-color);
        }

        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .validation-message.valid {
            color: var(--success-color);
        }

        .validation-message.invalid {
            color: var(--danger-color);
        }

        /* --- Report Items --- */
        .report-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.2s ease;
        }

        /* --- Modern UI Components --- */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* --- Range Slider --- */
        .range-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: var(--shadow-md);
        }

        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-md);
        }

        /* --- Color Picker --- */
        .color-picker {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }

        .color-option.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        /* --- File Upload --- */
        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: var(--bg-tertiary);
        }

        .file-upload.dragover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .file-preview {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .file-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .report-item:hover {
            background-color: var(--bg-secondary);
        }

        .report-item:last-child {
            border-bottom: none;
        }

        /* --- Enhanced Navigation --- */
        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .breadcrumb-item:not(:last-child)::after {
            content: '›';
            color: var(--text-muted);
        }

        .breadcrumb-link {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .breadcrumb-link:hover {
            color: var(--primary-color);
        }

        .breadcrumb-current {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* --- Enhanced Search --- */
        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .search-suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.2s ease;
        }

        .search-suggestion-item:hover {
            background-color: var(--bg-secondary);
        }

        .search-suggestion-item:last-child {
            border-bottom: none;
        }

        .recent-searches {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* --- Quick Filters --- */
        .quick-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-chip {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .filter-chip:hover,
        .filter-chip.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* --- Notification System --- */
        .toast-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            transform: translateX(100%);
            animation: slideIn 0.3s ease forwards;
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .toast.warning {
            border-left: 4px solid var(--warning-color);
        }

        .toast.info {
            border-left: 4px solid var(--info-color);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast.success .toast-icon { color: var(--success-color); }
        .toast.error .toast-icon { color: var(--danger-color); }
        .toast.warning .toast-icon { color: var(--warning-color); }
        .toast.info .toast-icon { color: var(--info-color); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.125rem;
            padding: 0.25rem;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .toast-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        @keyframes slideIn {
            to {
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            to {
                transform: translateX(100%);
            }
        }

        /* --- Camera Scanner --- */
        .camera-scanner { 
            background: var(--bg-secondary);
            border: 2px dashed var(--primary-color);
            border-radius: var(--radius-xl);
            padding: 2rem;
            text-align: center;
            margin: 1.5rem 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .camera-scanner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(99, 102, 241, 0.05) 50%, transparent 70%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .camera-scanner:hover {
            border-color: var(--accent-color);
            background: var(--bg-tertiary);
        }

        /* --- Barcode Container --- */
        .barcode-container {
            text-align: center;
            margin: 0.75rem 0;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }

        .barcode-container:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .barcode-svg { 
            max-width: 100%;
            height: auto;
        }
        .btn-danger {
  background: linear-gradient(135deg,#ff9a9e 0%,#fecfef 100%);
  color: #333;
}
    </style>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Toast Notifications Container -->
        <div id="toastContainer" class="toast-container"></div>
        
        <div class="header">
            <h1>✨ Soniya Dresses</h1>
            <p>Main Road, Pandharkawda | Complete Billing & Inventory Solution</p>
            <button id="darkModeToggle" class="btn" style="position: absolute; top: 20px; right: 20px;">
                <span id="darkModeIcon">🌙</span>
                <span id="darkModeText">Dark Mode</span>
            </button>
        </div>

        <!-- Mobile Sidebar Toggle -->
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <span>☰</span>
        </button>

        <!-- App Layout with Sidebar -->
        <div class="app-layout">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">Navigation</div>
                    <div class="sidebar-subtitle">Quick Access</div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
        <div class="nav-tabs">
                        <button class="nav-tab active" onclick="showTab('dashboard', this)">
                            <span class="nav-icon">📊</span>
                            <span class="nav-text">Dashboard</span>
                        </button>
                        <button class="nav-tab" onclick="showTab('about', this)">
                            <span class="nav-icon">ℹ️</span>
                            <span class="nav-text">About</span>
                        </button>
                    </div>
        </div>

                <div class="nav-section">
                    <div class="nav-section-title">Business Operations</div>
                    <div class="nav-tabs">
                        <button class="nav-tab" onclick="showTab('products', this)">
                            <span class="nav-icon">👗</span>
                            <span class="nav-text">Products</span>
                        </button>
                        <button class="nav-tab" onclick="showTab('inventory', this)">
                            <span class="nav-icon">📦</span>
                            <span class="nav-text">Inventory</span>
                        </button>
                        <button class="nav-tab" onclick="showTab('billing', this)">
                            <span class="nav-icon">💳</span>
                            <span class="nav-text">Billing</span>
                        </button>
                        <button class="nav-tab" onclick="showTab('invoices', this)">
                            <span class="nav-icon">📋</span>
                            <span class="nav-text">Invoice History</span>
                        </button>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <div class="nav-tabs">
                        <button class="nav-tab" onclick="showTab('suppliers', this)">
                            <span class="nav-icon">🤝</span>
                            <span class="nav-text">Suppliers</span>
                        </button>
                        <button class="nav-tab" onclick="showTab('expenses', this)">
                            <span class="nav-icon">💸</span>
                            <span class="nav-text">Expenses</span>
                        </button>
                        <button class="nav-tab" onclick="showTab('returns', this)">
                            <span class="nav-icon">🔄</span>
                            <span class="nav-text">Returns</span>
                        </button>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Tools & Analytics</div>
                    <div class="nav-tabs">
                        <button class="nav-tab" onclick="showTab('alerts', this)">
                            <span class="nav-icon">🚨</span>
                            <span class="nav-text">Alerts</span>
                        </button>
                        <button class="nav-tab" onclick="showTab('scanner', this)">
                            <span class="nav-icon">📱</span>
                            <span class="nav-text">Scanner</span>
                        </button>
                        <button class="nav-tab" onclick="showTab('reports', this)">
                            <span class="nav-icon">📈</span>
                            <span class="nav-text">Reports</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="main-content">
        <div id="dashboard" class="tab-content active">
                    <!-- Breadcrumbs -->
                    <div class="breadcrumbs">
                        <div class="breadcrumb-item">
                            <span class="breadcrumb-current">Dashboard</span>
                        </div>
                    </div>
                    
            <h2>📊 Dashboard Overview</h2>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <div class="quick-action-btn" onclick="showTab('products', document.querySelector('[onclick*=\'products\']'))">
                            <span class="quick-action-icon">👗</span>
                            <span>Add Product</span>
                        </div>
                        <div class="quick-action-btn" onclick="showTab('billing', document.querySelector('[onclick*=\'billing\']'))">
                            <span class="quick-action-icon">💳</span>
                            <span>New Invoice</span>
                        </div>
                        <div class="quick-action-btn" onclick="showTab('inventory', document.querySelector('[onclick*=\'inventory\']'))">
                            <span class="quick-action-icon">📦</span>
                            <span>Check Stock</span>
                        </div>
                        <div class="quick-action-btn" onclick="showTab('reports', document.querySelector('[onclick*=\'reports\']'))">
                            <span class="quick-action-icon">📈</span>
                            <span>View Reports</span>
                        </div>
                    </div>
                    
            <div class="stats-grid">
                        <div class="stat-card micro-interaction">
                    <div class="stat-number" id="totalProducts">0</div>
                    <div>Total Products</div>
                </div>
                        <div class="stat-card micro-interaction">
                    <div class="stat-number" id="totalStock">0</div>
                    <div>Items in Stock</div>
                </div>
                        <div class="stat-card micro-interaction">
                    <div class="stat-number" id="totalInvoices">0</div>
                    <div>Total Invoices</div>
                </div>
                        <div class="stat-card micro-interaction">
                    <div class="stat-number" id="todaySales">₹0</div>
                    <div>Today's Sales</div>
                </div>
                        <div class="stat-card micro-interaction">
                    <div class="stat-number" id="totalProfit">₹0</div>
                    <div>Total Profit</div>
                </div>
            </div>
            
            <div class="form-group">
                <button class="btn" onclick="exportToExcel()">📥 Export All Data to Excel</button>
                <button class="btn btn-secondary" onclick="importFromExcel()">📤 Import Data from Excel</button>
                <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelImport(event)">
            </div>
            
            <div style="margin-top: 30px;">
                <h3>Top 5 Best-Selling Products</h3>
                <div id="best-selling-products" class="product-grid"></div>
            </div>
        </div>
         <div id="about" class="tab-content">
    <h2>ℹ️ About Soniya Dresses Billing System</h2>
    <p>This comprehensive billing and inventory management solution is designed to streamline operations for Soniya Dresses. Below are the key features and how they work:</p>
    
    <div style="margin-top: 20px;">
        <h3>Core Features:</h3>
        <ul style="list-style-type: disc; padding-left: 20px;">
            <li><strong>Dashboard:</strong> Get a real-time overview of your business with key statistics like total products, stock, invoices, and today's sales. It also highlights top-selling products.</li>
            <li><strong>Product Management:</strong> Easily add new products with details such as name, category, price, quantity, and a unique barcode. You can also edit and delete product information.</li>
            <li><strong>Inventory Management:</strong> Keep a close eye on your stock levels, with a searchable list of all products and their current quantity and status.</li>
            <li><strong>Low Stock Alerts:</strong> The system automatically alerts you when products fall below a predefined low-stock threshold, helping you to reorder items in a timely manner.</li>
            <li><strong>Billing:</strong> Generate new invoices effortlessly by searching for products, adding them to a list, and applying overall or item-specific discounts.</li>
            <li><strong>Invoice History:</strong> All generated invoices are saved in a searchable history, allowing you to view and reprint them as needed.</li>
            <li><strong>Returns:</strong> Process product returns, automatically update inventory, and generate credit notes for customers.</li>
            <li><strong>Suppliers & Expenses:</strong> Manage your supplier database and track daily business expenses to get a clear picture of your finances.</li>
            <li><strong>Reports & Analytics:</strong> Generate detailed daily or custom date-range reports to analyze sales, profit, and loss statements.</li>
            <li><strong>Barcode Scanner:</strong> Quickly search for products by scanning their barcodes using your device's camera or by manual input, which also allows you to add products to an invoice instantly.</li>
        </ul>
    </div>
</div>
        <div id="products" class="tab-content">
            <h2>👗 Product Management</h2>
            <form id="productForm" onsubmit="addProduct(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Product Name:</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label>Size:</label>
                        <select id="productSize" required>
                            <option value="">Select Size</option>
                            <option value="XS">XS</option>
                            <option value="S">S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                            <option value="XXL">XXL</option>
                            <option value="Free Size">Free Size</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Color:</label>
                        <input type="text" id="productColor" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Purchase Price:</label>
                        <input type="number" id="purchasePrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Selling Price:</label>
                        <input type="number" id="sellingPrice" step="0.01" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quantity:</label>
                        <input type="number" id="productQuantity" required>
                    </div>
                    <div class="form-group">
                        <label>Supplier:</label>
                        <input type="text" id="productSupplier">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Product Image:</label>
                        <input type="file" id="productImage" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>Low Stock Threshold:</label>
                        <input type="number" id="productThreshold" value="5" min="0">
                    </div>
                </div>
                <button type="submit" class="btn">➕ Add Product</button>
            </form>

            <div class="search-bar">
                <span class="search-icon">🔍</span>
                <input type="text" id="productSearch" placeholder="Search products..." oninput="searchProducts()">
            </div>

            <div id="productsList" class="product-grid"></div>
        </div>

        <div id="inventory" class="tab-content">
            <h2>📦 Inventory Management</h2>
            <div class="search-bar">
                <span class="search-icon">🔍</span>
                <input type="text" id="inventorySearch" placeholder="Search inventory..." oninput="searchInventory()">
            </div>
            <div id="inventoryList"></div>
        </div>

        <div id="alerts" class="tab-content">
            <h2>🚨 Low Stock Alerts</h2>
            <div id="lowStockAlertsList" class="product-grid">
                <p>No low stock alerts at this time. All good!</p>
            </div>
        </div>

        <div id="billing" class="tab-content">
            <h2>💳 Create Invoice</h2>
            <div class="search-bar">
                <span class="search-icon">🔍</span>
                <input type="text" id="productSearchBilling" placeholder="Search products to add..." oninput="searchProductsForBilling()" autocomplete="off">
                <div id="productSuggestions" style="display: none; position: absolute; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; z-index: 10;"></div>
            </div>

            <div id="invoiceItems">
                <div class="invoice-item" style="font-weight: bold; background: #f8f9fa;">
                    <div>Product</div>
                    <div>Price</div>
                    <div>Qty</div>
                    <div>Discount%</div>
                    <div>Total</div>
                    <div>Action</div>
                </div>
            </div>

            <div class="form-group">
                <label>Overall Discount (%):</label>
                <input type="number" id="overallDiscount" value="0" min="0" max="100" onchange="calculateTotal()">
            </div>

            <div class="invoice-total">
                <div>Subtotal: ₹<span id="subtotal">0.00</span></div>
                <div>Discount: -₹<span id="discountAmount">0.00</span></div>
                <div style="font-size: 1.2rem; font-weight: bold;">Total: ₹<span id="totalAmount">0.00</span></div>
            </div>

            <div class="form-group">
                <button class="btn btn-success" onclick="generateInvoice()">🧾 Generate Invoice</button>
                <button class="btn btn-secondary" onclick="clearBilling()">🗑️ Clear All</button>
            </div>
        </div>
        
        <div id="returns" class="tab-content">
            <h2>🔄 Product Returns</h2>
            <form id="returnForm" onsubmit="processReturn(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Product Barcode/ID:</label>
                        <input type="text" id="returnBarcode" required>
                    </div>
                    <div class="form-group">
                        <label>Quantity to Return:</label>
                        <input type="number" id="returnQuantity" min="1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Reason for Return:</label>
                    <textarea id="returnReason" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">Process Return</button>
            </form>
            <div id="returnsList" style="margin-top: 20px;">
                <h3>Return History</h3>
                <div class="product-card">No returns have been processed yet.</div>
            </div>
        </div>
        
        <div id="suppliers" class="tab-content">
            <h2>🤝 Supplier Management</h2>
            <form id="supplierForm" onsubmit="addSupplier(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Supplier Name:</label>
                        <input type="text" id="supplierName" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Person:</label>
                        <input type="text" id="supplierContact">
                    </div>
                </div>
                <div class="form-group">
                    <label>Contact Info (Phone/Email):</label>
                    <input type="text" id="supplierInfo">
                </div>
                <button type="submit" class="btn">Add Supplier</button>
            </form>
            <div id="suppliersList" style="margin-top: 20px;">
                <h3>Supplier Database</h3>
                <div class="product-grid"></div>
            </div>
        </div>

        <div id="invoices" class="tab-content">
            <h2>📋 Invoice History</h2>
            <div class="search-bar">
                <span class="search-icon">🔍</span>
                <input type="text" id="invoiceSearch" placeholder="Search invoices..." oninput="searchInvoices()">
            </div>
            <div id="invoicesList"></div>
        </div> 

        <div id="expenses" class="tab-content">
            <h2>💸 Daily Expenses</h2>
            <form id="expenseForm" onsubmit="addExpense(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Date:</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    <div class="form-group">
                        <label>Category:</label>
                        <select id="expenseCategory" required>
                            <option value="">Select Category</option>
                            <option value="Rent">Rent</option>
                            <option value="Salaries">Salaries</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Supplies">Supplies</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Travel">Travel</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Description:</label>
                        <input type="text" id="expenseDescription" required>
                    </div>
                    <div class="form-group">
                        <label>Amount:</label>
                        <input type="number" id="expenseAmount" step="0.01" required>
                    </div>
                </div>
                <button type="submit" class="btn">➕ Add Expense</button>
            </form>
            <div style="margin-top: 20px;">
                <h3>Expense History</h3>
                <div id="expensesList" class="product-card">
                    <div class="expense-item" style="font-weight: bold; background: #f8f9fa;">
                        <div>Date</div>
                        <div>Category</div>
                        <div>Description</div>
                        <div>Amount</div>
                        <div>Action</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="scanner" class="tab-content">
    <h2>📱 Barcode Scanner</h2>
    <div class="camera-scanner">
        <h3>📷 Camera Scanner</h3>
        <p>Click the button to start the camera and scan a barcode.</p>
        <button class="btn" id="startScannerBtn" onclick="toggleScanner()">Start Scanner</button>
        <div id="reader" style="width: 100%; display: none; margin-top: 20px;"></div>
    </div>
    
    <div class="form-group" style="margin-top: 30px;">
        <label>Or Enter Barcode Manually:</label>
        <input type="text" id="manualBarcode" placeholder="Enter barcode..." onkeyup="if(event.key==='Enter') searchByBarcode()">
        <button class="btn" onclick="searchByBarcode()">🔍 Search Product</button>
    </div>

    <div id="scannedResult"></div>
</div>
    </div>
    <div id="reports" class="tab-content">
    <h2>📈 Sales & Business Reports</h2>
    <div class="form-row" style="margin-bottom: 20px;">
        <div class="form-group">
            <label>Start Date:</label>
            <input type="date" id="reportStartDate">
        </div>
        <div class="form-group">
            <label>End Date:</label>
            <input type="date" id="reportEndDate">
        </div>
    </div>
    <div style="margin-bottom: 20px;">
        <button class="btn" onclick="generateReport('custom')">Generate Report</button>
        <button class="btn btn-secondary" onclick="generateReport('today')">Today</button>
        <button class="btn btn-secondary" onclick="generateReport('thisWeek')">This Week</button>
        <button class="btn btn-secondary" onclick="generateReport('thisMonth')">This Month</button>
    </div>
    
    <div id="salesReport" class="report-section">
        <h3>Sales Report</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="reportSalesTotal">₹0</div>
                <div>Total Sales</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="reportInvoiceCount">0</div>
                <div>Total Invoices</div>
            </div>
        </div>
        <div class="product-card" style="margin-top:20px;">
            <h4>Sales by Category</h4>
            <ul id="salesByCategoryList" style="list-style:none; padding:0;"></ul>
        </div>
        <div class="product-card" style="margin-top:20px;">
            <h4>Top 10 Selling Products</h4>
            <ul id="topSellingProductsList" style="list-style:none; padding:0;"></ul>
        </div>
    </div>

    <div id="profitAndLossReport" class="report-section">
        <h3>Profit & Loss Report</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="reportRevenue">₹0</div>
                <div>Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="reportExpenses">₹0</div>
                <div>Total Expenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="reportProfit">₹0</div>
                <div>Net Profit / Loss</div>
            </div>
        </div>
        <div class="product-card" style="margin-top:20px;">
            <h4>Most Profitable Products</h4>
            <ul id="mostProfitableProductsList" style="list-style:none; padding:0;"></ul>
        </div>
        <div class="product-card" style="margin-top:20px;">
            <h4>Expense Breakdown</h4>
            <ul id="expenseBreakdownList" style="list-style:none; padding:0;"></ul>
        </div>
    </div>

    <div id="customerInsightsReport" class="report-section">
        <h3>Customer Insights</h3>
        <div class="product-card">
            <h4>Top 10 Customers by Spending</h4>
            <ul id="topCustomersList" style="list-style:none; padding:0;"></ul>
        </div>
    </div>
    
    <div id="inventoryReport" class="report-section">
        <h3>Inventory Report</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalProductsCount">0</div>
                <div>Total Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalInventoryValue">₹0</div>
                <div>Total Inventory Value</div>
            </div>
        </div>
        <div class="product-card" style="margin-top:20px;">
            <h4>Current Stock Levels</h4>
            <ul id="stockLevelsList" style="list-style:none; padding:0;"></ul>
        </div>
    </div>
                </div> <!-- Close reports tab-content -->

            </div> <!-- Close main-content -->
        </div> <!-- Close app-layout -->

    <div id="printModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePrintModal()">&times;</span>
            <div id="printableInvoice"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="printInvoice()">🖨️ Print Invoice</button>
                <button class="btn btn-secondary" onclick="downloadInvoice()">📥 Download PDF</button>
            </div>
        </div>
    </div>

    <!-- External libs -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <script>
    /*
     * ------------------------
     *  SUPABASE + STORAGE HTML
     * ------------------------
     *
     * 1) SQL schemas (run in Supabase SQL editor)
     *
     * -- Enable the extension for gen_random_uuid() if needed:
     * create extension if not exists "pgcrypto";
     *
     * create table products (
     *   id uuid primary key default gen_random_uuid(),
     *   name text not null,
     *   category text not null,
     *   size text,
     *   color text,
     *   purchase_price numeric,
     *   selling_price numeric,
     *   quantity int default 0,
     *   supplier text,
     *   barcode text unique,
     *   date_added date default now(),
     *   image text,
     *   min_stock_quantity int default 5
     * );
     *
     * create table suppliers (
     *   id uuid primary key default gen_random_uuid(),
     *   name text not null,
     *   contact_person text,
     *   contact_info text
     * );
     *
     * create table invoices (
     *   id uuid primary key default gen_random_uuid(),
     *   invoice_number serial unique,
     *   date timestamptz default now(),
     *   subtotal numeric,
     *   discount numeric,
     *   total numeric
     * );
     *
     * create table invoice_items (
     *   id uuid primary key default gen_random_uuid(),
     *   invoice_id uuid references invoices(id) on delete cascade,
     *   product_id uuid references products(id),
     *   name text,
     *   size text,
     *   color text,
     *   price numeric,
     *   purchase_price numeric,
     *   quantity int,
     *   discount numeric,
     *   total numeric
     * );
     *
     * create table expenses (
     *   id uuid primary key default gen_random_uuid(),
     *   date date not null,
     *   category text not null,
     *   description text,
     *   amount numeric not null
     * );
     *
     * create table returns (
     *   id uuid primary key default gen_random_uuid(),
     *   date timestamptz default now(),
     *   product_id uuid references products(id),
     *   product_name text,
     *   barcode text,
     *   quantity int,
     *   reason text,
     *   credit_amount numeric
     * );
     *
     * 2) Create a Storage Bucket in Supabase named: product-images
     *    Make it public (or configure signed URLs and adapt code).
     *
     * ------------------------
     * Replace the two placeholders below with:
     *   SUPABASE_URL and SUPABASE_KEY (anon public API key)
     * ------------------------
     */

    const SUPABASE_URL = "https://fmxrnqaauabwpgqibbgo.supabase.co"; // <-- replace
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZteHJucWFhdWFid3BncWliYmdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTQxMjMsImV4cCI6MjA3MjEzMDEyM30.nSPmqoXZa4htX0_h7jOCW0XrHzomFbEZFkZSchvU7bk"; // <-- replace (anon key)
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Application state arrays (populated from Supabase)
    let products = [];
    let invoices = [];
    let expenses = [];
    let returnsArr = [];
    let suppliers = [];
    let currentInvoiceItems = [];
    let invoiceCounter = 1; // not used for ID; invoices use uuid; kept for UI compatibility
   
    // Utility: fallback UUID generator
    function makeUUID() {
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      return 'id-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
    }

    // -------------------------
    // Storage: upload image and return public URL
    // -------------------------
    async function uploadImage(file, productId) {
      if (!file) return null;
      try {
        const ext = file.name.split('.').pop();
        // make unique filename using productId and timestamp
        const fileName = `product-${productId}-${Date.now()}.${ext}`;
        const { error: uploadError } = await supabase.storage
          .from('product-images')
          .upload(fileName, file, { upsert: true });
        if (uploadError) {
          console.error('Upload error', uploadError);
          alert('Image upload failed: ' + uploadError.message);
          return null;
        }
        const { data } = supabase.storage.from('product-images').getPublicUrl(fileName);
        return data?.publicUrl || null;
      } catch (err) {
        console.error('uploadImage exception', err);
        return null;
      }
    }

    // -------------------------
    // Loaders: load data from Supabase
    // -------------------------
    async function loadProducts() {
      const { data, error } = await supabase
        .from('products')
        .select('*')
        .order('date_added', { ascending: false });
      if (error) {
        console.error('loadProducts error', error);
        products = [];
      } else {
        products = data || [];
      }
      displayProducts();
      displayInventory();
      displayLowStockAlerts();
      updateDashboard();
    }
      document.addEventListener('DOMContentLoaded', (event) => {
  const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeIcon = document.getElementById('darkModeIcon');
        const darkModeText = document.getElementById('darkModeText');
        
  if (darkModeToggle) {
    darkModeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
            
            // Update button text and icon
            if (document.body.classList.contains('dark-mode')) {
              darkModeIcon.textContent = '☀️';
              darkModeText.textContent = 'Light Mode';
            } else {
              darkModeIcon.textContent = '🌙';
              darkModeText.textContent = 'Dark Mode';
            }
    });
  }
});
    async function loadSuppliers() {
      const { data, error } = await supabase.from('suppliers').select('*');
      if (error) {
        console.error('loadSuppliers error', error);
        suppliers = [];
      } else suppliers = data || [];
      displaySuppliers();
    }

    async function loadExpenses() {
      const { data, error } = await supabase.from('expenses').select('*').order('date', { ascending: false });
      if (error) {
        console.error('loadExpenses error', error);
        expenses = [];
      } else expenses = data || [];
      displayExpenses();
      updateDashboard();
    }

    // fetch invoices together with their items
    async function loadInvoices() {
      const { data, error } = await supabase
        .from('invoices')
        .select('*, invoice_items(*)')
        .order('date', { ascending: false });
      if (error) {
        console.error('loadInvoices error', error);
        invoices = [];
      } else invoices = data || [];
      displayInvoices();
      updateDashboard();
    }

    async function loadReturns() {
      const { data, error } = await supabase.from('returns').select('*').order('date', { ascending: false });
      if (error) {
        console.error('loadReturns error', error);
        returnsArr = [];
      } else returnsArr = data || [];
      displayReturns();
    }

    // -------------------------
    // Product CRUD
    // -------------------------
    async function addProduct(event) {
      event.preventDefault();
      // generate product id client-side
      const productId = makeUUID();

      const product = {
        id: productId,
        name: document.getElementById('productName').value,
        category: document.getElementById('productCategory').value,
        size: document.getElementById('productSize').value,
        color: document.getElementById('productColor').value,
        purchase_price: parseFloat(document.getElementById('purchasePrice').value) || 0,
        selling_price: parseFloat(document.getElementById('sellingPrice').value) || 0,
        quantity: parseInt(document.getElementById('productQuantity').value) || 0,
        supplier: document.getElementById('productSupplier').value || null,
        barcode: generateBarcode(),
        date_added: new Date().toISOString().split('T')[0],
        image: null,
        min_stock_quantity: parseInt(document.getElementById('productThreshold').value) || 5
      };

      // Insert product (without image first)
      const { error: insertError } = await supabase.from('products').insert([product]);
      if (insertError) {
        console.error('addProduct insert error', insertError);
        alert('Error adding product: ' + insertError.message);
        return;
      }

      // If image exists, upload and update
      const file = document.getElementById('productImage').files[0];
      if (file) {
        const imageUrl = await uploadImage(file, productId);
        if (imageUrl) {
          const { error: updateErr } = await supabase.from('products').update({ image: imageUrl }).eq('id', productId);
          if (updateErr) console.error('update after upload error', updateErr);
        }
      }

      document.getElementById('productForm').reset();
      alert('Product added successfully!');
      await loadProducts();
    }

    async function editProduct(productId) {
      // Fill form with product data and set onsubmit to update
      const product = products.find(p => p.id === productId);
      if (!product) return;
      document.getElementById('productName').value = product.name || '';
      document.getElementById('productCategory').value = product.category || '';
      document.getElementById('productSize').value = product.size || '';
      document.getElementById('productColor').value = product.color || '';
      document.getElementById('purchasePrice').value = product.purchase_price || '';
      document.getElementById('sellingPrice').value = product.selling_price || '';
      document.getElementById('productQuantity').value = product.quantity || 0;
      document.getElementById('productSupplier').value = product.supplier || '';
      document.getElementById('productThreshold').value = product.min_stock_quantity || 5;

      const form = document.getElementById('productForm');
      form.onsubmit = async function(ev) {
        ev.preventDefault();
        await updateProduct(productId);
      };

      // Switch tab
      showTab('products', document.querySelector('[onclick*="products"]'));
    }
  
    async function updateProduct(productId) {
      const values = {
        name: document.getElementById('productName').value,
        category: document.getElementById('productCategory').value,
        size: document.getElementById('productSize').value,
        color: document.getElementById('productColor').value,
        purchase_price: parseFloat(document.getElementById('purchasePrice').value) || 0,
        selling_price: parseFloat(document.getElementById('sellingPrice').value) || 0,
        quantity: parseInt(document.getElementById('productQuantity').value) || 0,
        supplier: document.getElementById('productSupplier').value || null,
        min_stock_quantity: parseInt(document.getElementById('productThreshold').value) || 5
      };

      // If a new image was selected upload it and include in update
      const file = document.getElementById('productImage').files[0];
      if (file) {
        const url = await uploadImage(file, productId);
        if (url) values.image = url;
      }

      const { error } = await supabase.from('products').update(values).eq('id', productId);
      if (error) {
        console.error('updateProduct error', error);
        alert('Error updating product: ' + error.message);
      } else {
        alert('Product updated successfully!');
        document.getElementById('productForm').onsubmit = addProduct; // reset
        document.getElementById('productForm').reset();
        await loadProducts();
      }
    }

    async function deleteProduct(productId) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      const { error } = await supabase.from('products').delete().eq('id', productId);
      if (error) {
        console.error('deleteProduct error', error);
        alert('Error deleting product: ' + error.message);
      } else {
        await loadProducts();
      }
    }
    async function deleteReturn(returnId) {
    if (!confirm('Are you sure you want to delete this return? This action is irreversible.')) {
        return;
    }
    const { error } = await supabase
        .from('returns')
        .delete()
        .eq('id', returnId);

    if (error) {
        console.error('Error deleting return:', error);
        alert('Error deleting return: ' + error.message);
    } else {
        alert('Return deleted successfully!');
        await loadReturns(); // Reload the list to show the change
    }
}
    function downloadInvoice() {
  const element = document.getElementById('printableInvoice');
  const opt = {
    margin: [10, 5, 10, 5],
    filename: 'invoice.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a5', orientation: 'portrait' }
  };
  html2pdf().from(element).set(opt).save();
}

    // -------------------------
    // Display functions (use existing UI functions but reading from arrays)
    // -------------------------
    function displayProducts() {
      const productsList = document.getElementById('productsList');
      const searchTerm = document.getElementById('productSearch')?.value.toLowerCase() || '';

      const filteredProducts = products.filter(product =>
          (product.name || '').toLowerCase().includes(searchTerm) ||
          (product.category || '').toLowerCase().includes(searchTerm) ||
          (product.barcode || '').toLowerCase().includes(searchTerm)
      );

      productsList.innerHTML = filteredProducts.map(product => `
          <div class="product-card">
              ${product.image ? `<img src="${product.image}" alt="${product.name}">` : ''}
              <h3>${product.name}</h3>
              <div class="barcode-container">
                  <svg id="barcode-${product.id}" class="barcode-svg"></svg>
              </div>
              <p><strong>Category:</strong> ${product.category}</p>
              <p><strong>Size:</strong> ${product.size} | <strong>Color:</strong> ${product.color}</p>
              <p><strong>Price:</strong> ₹${product.selling_price || 0} | <strong>Stock:</strong> ${product.quantity}</p>
              <p><strong>Supplier:</strong> ${product.supplier || ''}</p>
              <div>
                  <button class="btn btn-secondary" onclick="editProduct('${product.id}')">✏️ Edit</button>
                  <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">🗑️ Delete</button>
                  <button class="btn btn-info" onclick="printBarcode('barcode-${product.id}')">🖨️ Print Barcode</button>
              </div>
          </div>
      `).join('');

      // Generate barcode svgs after rendering
      filteredProducts.forEach(product => {
        try {
          JsBarcode(`#barcode-${product.id}`, product.barcode || '', {
            format: "CODE128",
            displayValue: true,
            lineColor: "#333",
            width: 2,
            height: 40,
            margin: 10
          });
        } catch (e) {
          // ignore barcode errors
        }
      });
    }

    function searchProducts(){ displayProducts(); }
    function searchInventory(){ displayInventory(); }

    function displayInventory() {
      const inventoryList = document.getElementById('inventoryList');
      const searchTerm = document.getElementById('inventorySearch')?.value.toLowerCase() || '';
      const filteredProducts = products.filter(product =>
          (product.name || '').toLowerCase().includes(searchTerm) ||
          (product.barcode || '').toLowerCase().includes(searchTerm)
      );

      inventoryList.innerHTML = `
          <div class="invoice-item" style="font-weight: bold; background: #f8f9fa; margin-bottom: 10px;">
              <div>Product</div>
              <div>Barcode</div>
              <div>Category</div>
              <div>Stock</div>
              <div>Value</div>
              <div>Status</div>
          </div>
          ${filteredProducts.map(product => {
              const status = product.quantity < (product.min_stock_quantity || 5) ? 'Low Stock' : product.quantity === 0 ? 'Out of Stock' : 'In Stock';
              const statusColor = product.quantity < (product.min_stock_quantity || 5) ? '#ff6b6b' : product.quantity === 0 ? '#ff4757' : '#2ed573';
              return `
                  <div class="invoice-item">
                      <div>${product.name} (${product.size || ''}, ${product.color || ''})</div>
                      <div>${product.barcode || ''}</div>
                      <div>${product.category || ''}</div>
                      <div>${product.quantity}</div>
                      <div>₹${((product.selling_price || 0) * (product.quantity || 0)).toFixed(2)}</div>
                      <div style="color: ${statusColor}; font-weight: bold;">${status}</div>
                  </div>
              `;
          }).join('')}
      `;
    }

    function displayLowStockAlerts() {
      const alertsList = document.getElementById('lowStockAlertsList');
      const lowStockProducts = products.filter(p => p.quantity <= (p.min_stock_quantity || 5) && p.quantity > 0);
      if (lowStockProducts.length > 0) {
        alertsList.innerHTML = lowStockProducts.map(product => `
            <div class="product-card">
                <h3>${product.name}</h3>
                <p><strong>Barcode:</strong> ${product.barcode}</p>
                <p><strong>Category:</strong> ${product.category}</p>
                <p><strong>Current Stock:</strong> <span style="color: #ff4757; font-weight: bold;">${product.quantity}</span></p>
                <p><strong>Threshold:</strong> ${product.min_stock_quantity || 5}</p>
                <button class="btn" onclick="editProduct('${product.id}')">✏️ Reorder</button>
            </div>
        `).join('');
      } else {
        alertsList.innerHTML = '<p>No low stock alerts at this time. All good!</p>';
      }
    }

    // -------------------------
    // Billing / Invoice functions
    // -------------------------
    function searchProductsForBilling() {
      const searchTerm = document.getElementById('productSearchBilling').value.toLowerCase();
      const suggestions = document.getElementById('productSuggestions');
      if (searchTerm.length < 2) {
        suggestions.style.display = 'none';
        return;
      }
      const filteredProducts = products.filter(p =>
          (p.name || '').toLowerCase().includes(searchTerm) ||
          (p.barcode || '').toLowerCase().includes(searchTerm)
      ).filter(p => p.quantity > 0);

      let suggestionsHtml = '';
      if (filteredProducts.length > 0) {
        suggestionsHtml = filteredProducts.map(p => `
          <div style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;" onclick="addProductToInvoice('${p.id}')">
            ${p.name} - ${p.barcode || ''} (Stock: ${p.quantity})
          </div>
        `).join('');
      } else {
        suggestionsHtml = '<div style="padding:10px;color:#888;">No products found.</div>';
      }
      suggestions.innerHTML = suggestionsHtml;
      suggestions.style.display = 'block';
    }

    function addProductToInvoice(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;

      const existingItem = currentInvoiceItems.find(item => item.productId === productId);
      if (existingItem) {
        if (existingItem.quantity < product.quantity) {
          existingItem.quantity++;
          existingItem.total = existingItem.price * existingItem.quantity * (1 - existingItem.discount/100);
        } else {
          alert('Not enough stock available!');
          return;
        }
      } else {
        currentInvoiceItems.push({
          productId: productId,
          name: product.name,
          size: product.size,
          color: product.color,
          price: product.selling_price || 0,
          purchasePrice: product.purchase_price || 0,
          quantity: 1,
          discount: 0,
          total: product.selling_price || 0
        });
      }
      document.getElementById('productSearchBilling').value = '';
      document.getElementById('productSuggestions').style.display = 'none';
      displayInvoiceItems();
    }

    function displayInvoiceItems() {
      const invoiceItems = document.getElementById('invoiceItems');
      const header = `
        <div class="invoice-item" style="font-weight: bold; background: #f8f9fa;">
            <div>Product</div>
            <div>Price</div>
            <div>Qty</div>
            <div>Discount%</div>
            <div>Total</div>
            <div>Action</div>
        </div>
      `;
      const items = currentInvoiceItems.map((item, index) => `
        <div class="invoice-item">
            <div>${item.name} (${item.size || ''}, ${item.color || ''})</div>
            <div>₹${item.price}</div>
            <div>
                <input type="number" value="${item.quantity}" min="1" onchange="updateItemQuantity(${index}, this.value)" style="width:60px;padding:5px;">
            </div>
            <div>
                <input type="number" value="${item.discount}" min="0" max="100" onchange="updateItemDiscount(${index}, this.value)" style="width:60px;padding:5px;">
            </div>
            <div>₹${item.total.toFixed(2)}</div>
            <div>
                <button class="btn btn-danger" onclick="removeItemFromInvoice(${index})">❌</button>
            </div>
        </div>
      `).join('');
      invoiceItems.innerHTML = header + items;
      calculateTotal();
    }

    function updateItemQuantity(index, quantity) {
      const item = currentInvoiceItems[index];
      const product = products.find(p => p.id === item.productId);
      if (quantity > product.quantity) {
        alert('Not enough stock available!');
        return;
      }
      item.quantity = parseInt(quantity);
      item.total = item.price * item.quantity * (1 - item.discount/100);
      displayInvoiceItems();
    }

    function updateItemDiscount(index, discount) {
      const item = currentInvoiceItems[index];
      item.discount = parseFloat(discount);
      item.total = item.price * item.quantity * (1 - item.discount/100);
      displayInvoiceItems();
    }

    function removeItemFromInvoice(index) {
      currentInvoiceItems.splice(index,1);
      displayInvoiceItems();
    }

    function calculateTotal() {
      const subtotal = currentInvoiceItems.reduce((sum,item) => sum + item.total, 0);
      const overallDiscount = parseFloat(document.getElementById('overallDiscount').value) || 0;
      const discountAmount = (subtotal * overallDiscount) / 100;
      const total = subtotal - discountAmount;
      document.getElementById('subtotal').textContent = subtotal.toFixed(2);
      document.getElementById('discountAmount').textContent = discountAmount.toFixed(2);
      document.getElementById('totalAmount').textContent = total.toFixed(2);
    }

    async function generateInvoice() {
      if (currentInvoiceItems.length === 0) {
        alert('Please add at least one product.');
        return;
      }
      const invoiceObj = {
        subtotal: parseFloat(document.getElementById('subtotal').textContent),
        discount: parseFloat(document.getElementById('discountAmount').textContent),
        total: parseFloat(document.getElementById('totalAmount').textContent),
        items: [...currentInvoiceItems]
      };

      // Insert invoice
      const { data: invoiceData, error: invoiceError } = await supabase.from('invoices').insert([{
        subtotal: invoiceObj.subtotal,
        discount: invoiceObj.discount,
        total: invoiceObj.total
      }]).select('id').single();

      if (invoiceError) {
        console.error('generateInvoice insert invoice error', invoiceError);
        alert('Error saving invoice: ' + invoiceError.message);
        return;
      }

      const invoiceId = invoiceData.id;
      // Prepare invoice_items
      const items = invoiceObj.items.map(i => ({
        invoice_id: invoiceId,
        product_id: i.productId,
        name: i.name,
        size: i.size,
        color: i.color,
        price: i.price,
        purchase_price: i.purchasePrice,
        quantity: i.quantity,
        discount: i.discount,
        total: i.total
      }));

      const { error: itemsErr } = await supabase.from('invoice_items').insert(items);
      if (itemsErr) {
        console.error('generateInvoice insert items error', itemsErr);
        // not aborting, but notify
      }

      // Update stock for each product
      for (const item of invoiceObj.items) {
        try {
          const product = products.find(p => p.id === item.productId);
          if (product) {
            const newQty = (product.quantity || 0) - item.quantity;
            await supabase.from('products').update({ quantity: newQty }).eq('id', product.id);
          }
        } catch (err) {
          console.error('Error updating product qty for', item.productId, err);
        }
      }

      // Refresh data and show invoice
      await loadProducts();
      await loadInvoices();

      // Build invoice object for print
      const printedInvoice = {
        id: invoiceId,
        date: new Date().toISOString(),
        items: invoiceObj.items,
        subtotal: invoiceObj.subtotal,
        discount: invoiceObj.discount,
        total: invoiceObj.total
      };
      showPrintModal(printedInvoice);
      clearBilling();
      updateDashboard();
    }

    function clearBilling() {
      currentInvoiceItems = [];
      document.getElementById('overallDiscount').value = '0';
      displayInvoiceItems();
    }

    function showPrintModal(invoice) {
      const modal = document.getElementById('printModal');
      const printableInvoice = document.getElementById('printableInvoice');

      // First product image if available
      const firstItemProduct = invoice.items.length > 0 ? products.find(p => p.id === invoice.items[0].productId) : null;
      const productImageHtml = firstItemProduct && firstItemProduct.image ? `<img src="${firstItemProduct.image}" style="max-width:100%; border-radius:10px; margin-bottom:10px;">` : '';
      const firstProductBarcode = firstItemProduct ? firstItemProduct.barcode : null;
      const barcodeSvgHtml = firstProductBarcode ? `<svg id="invoice-barcode"></svg>` : '';

      printableInvoice.innerHTML = `
        <div class="print-invoice">
          <div class="print-header">
            <h2>SONIYA DRESSES</h2>
            <p>Main Road, Pandharkawda</p>
            <p>Phone: +91-XXXXXXXXXX</p>
          </div>

          <div class="print-row"><span>Invoice #:</span><span></span></div>
          <div class="print-row"><span>Date:</span><span>${new Date(invoice.date).toLocaleDateString()}</span></div>
          <hr style="margin:10px 0;">
          ${productImageHtml}
          <div style="text-align:center;margin:10px 0;">${barcodeSvgHtml}</div>
          <hr style="margin:10px 0;">
          ${invoice.items.map(item => `
            <div class="print-row"><span>${item.name}</span><span></span></div>
            <div class="print-row" style="font-size:10px;"><span>${item.size || ''}, ${item.color || ''}</span><span></span></div>
            <div class="print-row"><span>${item.quantity} x ₹${item.price}</span><span>₹${item.total.toFixed(2)}</span></div>
          `).join('')}

          <div class="print-total">
            <div class="print-row"><span>Subtotal:</span><span>₹${invoice.subtotal.toFixed(2)}</span></div>
            <div class="print-row"><span>Discount:</span><span>-₹${invoice.discount.toFixed(2)}</span></div>
            <div class="print-row" style="font-size:14px;"><span>TOTAL:</span><span>₹${invoice.total.toFixed(2)}</span></div>
          </div>

          <div style="text-align:center;margin-top:20px;font-size:10px;">
            <p>Thank you for shopping with us!</p>
            <p>Visit again for latest fashion trends</p>
          </div>
        </div>
      `;

      if (firstProductBarcode) {
        try {
          JsBarcode("#invoice-barcode", firstProductBarcode, {
            format: "CODE128",
            displayValue: true,
            lineColor: "#000",
            width: 1,
            height: 30,
            margin: 5
          });
        } catch (e) {}
      }

      modal.style.display = 'block';
    }

    function closePrintModal(){ document.getElementById('printModal').style.display = 'none'; }

    function printInvoice() {
      const printContent = document.getElementById('printableInvoice').innerHTML;
      const originalContent = document.body.innerHTML;
      document.body.innerHTML = printContent;
      window.print();
      document.body.innerHTML = originalContent;
      location.reload();
    }

    function downloadInvoice(){ alert('PDF download can be implemented with jsPDF or html2pdf.'); }

    function displayInvoices() {
      const invoicesList = document.getElementById('invoicesList');
      const searchTerm = document.getElementById('invoiceSearch')?.value.toLowerCase() || '';

      const filteredInvoices = invoices.filter(inv => 
        (inv.id || '').toString().includes(searchTerm) || 
        (inv.date || '').toString().includes(searchTerm)
      );

      invoicesList.innerHTML = filteredInvoices.map(inv => `
        <div class="product-card">
          <h3>Invoice #${inv.id}</h3>
          <p><strong>Date:</strong> ${new Date(inv.date).toLocaleDateString()}</p>
          <p><strong>Total:</strong> ₹${(inv.total || 0).toFixed(2)}</p>
          <p><strong>Items:</strong> ${inv.invoice_items ? inv.invoice_items.length : 0}</p>
          <div>
            <button class="btn btn-secondary" onclick="viewInvoice('${inv.id}')">👁️ View</button>
            <button class="btn" onclick="reprintInvoice('${inv.id}')">🖨️ Print</button>
            <button class="btn btn-danger" onclick="deleteInvoice('${inv.id}')">🗑️ Delete</button>
          </div>
        </div>
      `).join('');
    }

    // --- Delete Invoice Function ---
    async function deleteInvoice(invoiceId) {
      if (!confirm('Are you sure you want to delete this invoice? This action cannot be undone.')) {
        return;
      }

      try {
        // First delete invoice items
        const { error: itemsError } = await supabase
          .from('invoice_items')
          .delete()
          .eq('invoice_id', invoiceId);

        if (itemsError) {
          console.error('Error deleting invoice items:', itemsError);
          showToast('error', 'Error', 'Failed to delete invoice items');
          return;
        }

        // Then delete the invoice
        const { error: invoiceError } = await supabase
          .from('invoices')
          .delete()
          .eq('id', invoiceId);

        if (invoiceError) {
          console.error('Error deleting invoice:', invoiceError);
          showToast('error', 'Error', 'Failed to delete invoice');
          return;
        }

        // Refresh data
        await loadInvoices();
        showToast('success', 'Success', 'Invoice deleted successfully');
      } catch (error) {
        console.error('Error deleting invoice:', error);
        showToast('error', 'Error', 'An unexpected error occurred');
      }
    }

    function viewInvoice(invoiceId) {
      const inv = invoices.find(i => i.id === invoiceId);
      if (inv) {
        // if invoice doesn't include items loaded, fetch them
        if (!inv.invoice_items) {
          supabase.from('invoice_items').select('*').eq('invoice_id', invoiceId).then(({data, error})=>{
            if (!error) {
              inv.invoice_items = data;
              showPrintModal({
                id: inv.id,
                date: inv.date,
                items: inv.invoice_items,
                subtotal: inv.subtotal || 0,
                discount: inv.discount || 0,
                total: inv.total || 0
              });
            }
          });
        } else {
          showPrintModal({
            id: inv.id,
            date: inv.date,
            items: inv.invoice_items,
            subtotal: inv.subtotal || 0,
            discount: inv.discount || 0,
            total: inv.total || 0
          });
        }
      }
    }

    function reprintInvoice(invoiceId) { viewInvoice(invoiceId); }

    // -------------------------
    // Returns
    // -------------------------
    async function processReturn(event) {
      event.preventDefault();
      const barcode = document.getElementById('returnBarcode').value.trim();
      const quantity = parseInt(document.getElementById('returnQuantity').value);
      const reason = document.getElementById('returnReason').value.trim();

      const product = products.find(p => p.barcode === barcode);
      if (!product) {
        alert('Product not found. Please check the barcode.');
        return;
      }
      if (quantity <= 0 || isNaN(quantity)) {
        alert('Please enter a valid quantity.');
        return;
      }

      const returnRecord = {
        product_id: product.id,
        product_name: product.name,
        barcode: product.barcode,
        quantity,
        reason,
        credit_amount: (product.selling_price || 0) * quantity
      };

      const { error: insertErr } = await supabase.from('returns').insert([returnRecord]);
      if (insertErr) {
        console.error('processReturn insert error', insertErr);
        alert('Error saving return: ' + insertErr.message);
        return;
      }

      // Update stock
      const newQty = (product.quantity || 0) + quantity;
      await supabase.from('products').update({ quantity: newQty }).eq('id', product.id);

      document.getElementById('returnForm').reset();
      await loadReturns();
      await loadProducts();
      showCreditNoteModal({ id: makeUUID(), date: new Date().toISOString(), ...returnRecord });
    }

    function displayReturns() {
      const returnsList = document.getElementById('returnsList');
      const items = returnsArr.map(ret => `
        <div class="product-card">
          <h4>Return ID: ${ret.id}</h4>
          <p><strong>Date:</strong> ${new Date(ret.date).toLocaleDateString()}</p>
          <p><strong>Product:</strong> ${ret.product_name}</p>
          <p><strong>Quantity:</strong> ${ret.quantity}</p>
          <p><strong>Credit Amount:</strong> ₹${(ret.credit_amount || 0).toFixed(2)}</p>
          <p><strong>Reason:</strong> ${ret.reason}</p>
          <button class="btn btn-danger" onclick="deleteReturn('${ret.id}')">🗑️ Delete</button>
        </div>
      `).join('');
      returnsList.innerHTML = items || '<div class="product-card">No returns have been processed yet.</div>';
    }

    function showCreditNoteModal(creditNote) {
      const modal = document.getElementById('printModal');
      const printableInvoice = document.getElementById('printableInvoice');
      printableInvoice.innerHTML = `
        <div class="print-invoice">
          <div class="print-header"><h2>SONIYA DRESSES</h2><h3>CREDIT NOTE</h3><p>Main Road, Pandharkawda</p></div>
          <div class="print-row"><span>Credit Note #:</span><span>${creditNote.id}</span></div>
          <div class="print-row"><span>Date:</span><span>${new Date(creditNote.date).toLocaleDateString()}</span></div>
          <hr style="margin:10px 0;">
          <div class="print-row"><span>Product:</span><span>${creditNote.product_name}</span></div>
          <div class="print-row"><span>Quantity:</span><span>${creditNote.quantity}</span></div>
          <div class="print-row"><span>Reason:</span><span>${creditNote.reason}</span></div>
          <div class="print-total"><div class="print-row" style="font-size:14px;"><span>Credit Amount:</span><span>₹${(creditNote.credit_amount||0).toFixed(2)}</span></div></div>
          <div style="text-align:center;margin-top:20px;font-size:10px;"><p>This credit note can be used for a future purchase.</p></div>
        </div>
      `;
      modal.style.display = 'block';
    }

    // -------------------------
    // Suppliers CRUD
    // -------------------------
    async function addSupplier(event) {
      event.preventDefault();
      const supplier = {
        name: document.getElementById('supplierName').value,
        contact_person: document.getElementById('supplierContact').value,
        contact_info: document.getElementById('supplierInfo').value
      };
      const { error } = await supabase.from('suppliers').insert([supplier]);
      if (error) {
        console.error('addSupplier error', error);
        alert('Error adding supplier: ' + error.message);
      } else {
        alert('Supplier added successfully!');
        document.getElementById('supplierForm').reset();
        await loadSuppliers();
      }
    }

    async function deleteSupplier(supplierId) {
      if (!confirm('Delete supplier?')) return;
      const { error } = await supabase.from('suppliers').delete().eq('id', supplierId);
      if (error) console.error('deleteSupplier error', error);
      await loadSuppliers();
    }

    function displaySuppliers() {
      const suppliersList = document.getElementById('suppliersList').querySelector('.product-grid');
      const items = suppliers.map(sup => `
        <div class="product-card">
          <h4>${sup.name}</h4>
          <p><strong>Contact:</strong> ${sup.contact_person || ''}</p>
          <p><strong>Info:</strong> ${sup.contact_info || ''}</p>
          <button class="btn btn-danger" onclick="deleteSupplier('${sup.id}')">Delete</button>
        </div>
      `).join('');
      suppliersList.innerHTML = items || '<div class="product-card">No suppliers added yet.</div>';
    }

    // -------------------------
    // Expenses CRUD
    // -------------------------
    async function addExpense(event) {
      event.preventDefault();
      const expense = {
        date: document.getElementById('expenseDate').value,
        category: document.getElementById('expenseCategory').value,
        description: document.getElementById('expenseDescription').value,
        amount: parseFloat(document.getElementById('expenseAmount').value) || 0
      };
      const { error } = await supabase.from('expenses').insert([expense]);
      if (error) {
        console.error('addExpense error', error);
        alert('Error adding expense: ' + error.message);
      } else {
        document.getElementById('expenseForm').reset();
        await loadExpenses();
        alert('Expense added successfully!');
      }
    }

    async function deleteExpense(expenseId) {
      if (!confirm('Are you sure you want to delete this expense?')) return;
      const { error } = await supabase.from('expenses').delete().eq('id', expenseId);
      if (error) console.error('deleteExpense error', error);
      await loadExpenses();
    }

    function displayExpenses() {
      const expensesList = document.getElementById('expensesList');
      const header = `
        <div class="expense-item" style="font-weight: bold; background: #f8f9fa;">
            <div>Date</div><div>Category</div><div>Description</div><div>Amount</div><div>Action</div>
        </div>
      `;
      const items = expenses.map(exp => `
        <div class="expense-item">
          <div>${new Date(exp.date).toLocaleDateString()}</div>
          <div>${exp.category}</div>
          <div>${exp.description}</div>
          <div>₹${(exp.amount||0).toFixed(2)}</div>
          <div><button class="btn btn-danger" onclick="deleteExpense('${exp.id}')">❌</button></div>
        </div>
      `).join('');
      expensesList.innerHTML = header + items;
    }

    // -------------------------
    // Reports / Analytics helpers
    // -------------------------
    function updateDashboard() {
      document.getElementById('totalProducts').textContent = products.length;
      document.getElementById('totalStock').textContent = products.reduce((sum, p) => sum + (p.quantity || 0), 0);
      document.getElementById('totalInvoices').textContent = invoices.length;

      const today = new Date().toDateString();
      const todaySales = invoices
        .filter(inv => new Date(inv.date).toDateString() === today)
        .reduce((sum, inv) => sum + (inv.total || 0), 0);
      document.getElementById('todaySales').textContent = '₹' + todaySales.toFixed(2);

      const totalRevenue = invoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
      const totalExpenses = expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
      const totalProfit = totalRevenue - totalExpenses;
      document.getElementById('totalProfit').textContent = '₹' + totalProfit.toFixed(2);

      displayBestSellingProducts();
    }
     // --- Core data fetching functions ---
    async function fetchProducts() {
        const { data, error } = await supabase.from('products').select('*');
        if (error) console.error('Error fetching products:', error);
        else products = data;
    }
    async function fetchSuppliers() {
        const { data, error } = await supabase.from('suppliers').select('*');
        if (error) console.error('Error fetching suppliers:', error);
        else suppliers = data;
    }
    async function fetchInvoices() {
        const { data, error } = await supabase.from('invoices').select('*, invoice_items(*)');
        if (error) console.error('Error fetching invoices:', error);
        else invoices = data;
    }
    async function fetchExpenses() {
        const { data, error } = await supabase.from('expenses').select('*');
        if (error) console.error('Error fetching expenses:', error);
        else expenses = data;
    }
    async function fetchReturns() {
        const { data, error } = await supabase.from('returns').select('*');
        if (error) console.error('Error fetching returns:', error);
        else returns = data;
    }

    
    // --- Reports functionality (Updated) ---
async function generateReport(period) {
    let startDate, endDate;
    const now = new Date();
    now.setHours(0, 0, 0, 0);

    // Date range logic (same as before)
    if (period === 'today') {
        startDate = new Date(now);
        endDate = new Date(now);
        endDate.setHours(23, 59, 59, 999);
    } else if (period === 'thisWeek') {
        const day = now.getDay();
        startDate = new Date(now.setDate(now.getDate() - day)); // Sunday
        endDate = new Date(now.setDate(now.getDate() - day + 6)); // Saturday
        endDate.setHours(23, 59, 59, 999);
    } else if (period === 'thisMonth') {
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        endDate.setHours(23, 59, 59, 999);
    } else { // 'custom'
        startDate = document.getElementById('reportStartDate').value ? new Date(document.getElementById('reportStartDate').value) : null;
        endDate = document.getElementById('reportEndDate').value ? new Date(document.getElementById('reportEndDate').value) : null;
        if (!startDate || !endDate) {
            alert('Please select a valid date range.');
            return;
        }
        endDate.setHours(23, 59, 59, 999);
    }

    const startISO = startDate.toISOString();
    const endISO = endDate.toISOString();

    // Fetch all necessary data with a single query
    const { data: reportData, error } = await supabase
        .from('invoices')
        .select(`
            total,
            customer_id,
            invoice_items(
                product_id,
                quantity,
                price,
                purchase_price,
                products(name, category)
            )
        `)
        .gte('created_at', startISO) // Assuming 'created_at' is your date field
        .lte('created_at', endISO);

    // Fetch expenses and customers separately as they are for different reports
    const { data: reportExpenses } = await supabase
        .from('expenses')
        .select('amount, category');
        
    const { data: customersData } = await supabase.from('customers').select('*');

    if (error) {
        console.error('Report generation error:', error);
        alert('Failed to fetch data for the report.');
        return;
    }

    // --- Data Processing ---
    let totalSales = 0;
    const salesByCategory = {};
    const productSales = {};
    const productProfit = {};
    const customerSpending = {};

    reportData.forEach(inv => {
        totalSales += inv.total || 0;
        
        // Customer insights
        if (inv.customer_id) {
            customerSpending[inv.customer_id] = (customerSpending[inv.customer_id] || 0) + inv.total;
        }

        const items = inv.invoice_items || [];
        items.forEach(item => {
            const productName = item.products.name;
            const productCategory = item.products.category;
            const productQuantity = item.quantity;
            const productPrice = item.price;
            const purchasePrice = item.purchase_price;

            // Sales by category
            salesByCategory[productCategory] = (salesByCategory[productCategory] || 0) + (productPrice * productQuantity);

            // Top selling products
            productSales[productName] = (productSales[productName] || 0) + productQuantity;

            // Most profitable products
            const profit = (productPrice - purchasePrice) * productQuantity;
            productProfit[productName] = (productProfit[productName] || 0) + profit;
        });
    });

    // --- Report Display ---

    // Sales Report
    document.getElementById('reportSalesTotal').textContent = `₹${totalSales.toFixed(2)}`;
    document.getElementById('reportInvoiceCount').textContent = reportData.length;
    
    // Sort and display sales by category
    const categoryList = document.getElementById('salesByCategoryList');
    categoryList.innerHTML = Object.entries(salesByCategory).map(([category, sales]) => `
        <li class="report-item"><span>${category}:</span><span>₹${sales.toFixed(2)}</span></li>
    `).join('');

    // Sort and display top 10 selling products
    const topSellingList = document.getElementById('topSellingProductsList');
    const sortedSales = Object.entries(productSales).sort(([, a], [, b]) => b - a).slice(0, 10);
    topSellingList.innerHTML = sortedSales.map(([productName, quantity]) => `
        <li class="report-item"><span>${productName}:</span><span>${quantity} sold</span></li>
    `).join('');

    // Profit & Loss Report
    const totalRevenue = reportData.reduce((sum, inv) => sum + (inv.total || 0), 0);
    const totalPurchaseCost = reportData.reduce((sum, inv) => {
        const items = inv.invoice_items || [];
        return sum + items.reduce((subSum, item) => subSum + ((item.purchase_price || 0) * (item.quantity || 0)), 0);
    }, 0);
    const grossProfit = totalRevenue - totalPurchaseCost;
    const totalExpenses = reportExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
    const netProfit = grossProfit - totalExpenses;

    document.getElementById('reportRevenue').textContent = `₹${totalRevenue.toFixed(2)}`;
    document.getElementById('reportExpenses').textContent = `₹${totalExpenses.toFixed(2)}`;
    document.getElementById('reportProfit').textContent = `₹${netProfit.toFixed(2)}`;

    // Sort and display most profitable products
    const profitableList = document.getElementById('mostProfitableProductsList');
    const sortedProfit = Object.entries(productProfit).sort(([, a], [, b]) => b - a).slice(0, 10);
    profitableList.innerHTML = sortedProfit.map(([productName, profit]) => `
        <li class="report-item"><span>${productName}:</span><span style="color:${profit >= 0 ? 'green' : 'red'};">₹${profit.toFixed(2)}</span></li>
    `).join('');

    // Display expense breakdown
    const expenseBreakdown = {};
    reportExpenses.forEach(exp => {
        const category = exp.category || 'Uncategorized';
        expenseBreakdown[category] = (expenseBreakdown[category] || 0) + exp.amount;
    });
    const expenseList = document.getElementById('expenseBreakdownList');
    expenseList.innerHTML = Object.entries(expenseBreakdown).map(([category, amount]) => `
        <li class="report-item"><span>${category}:</span><span>₹${amount.toFixed(2)}</span></li>
    `).join('');

    // Customer Insights
    const topCustomersList = document.getElementById('topCustomersList');
    const sortedCustomers = Object.entries(customerSpending).sort(([, a], [, b]) => b - a).slice(0, 10);
    topCustomersList.innerHTML = sortedCustomers.map(([customerId, totalSpent]) => {
        const customer = customersData.find(c => c.id === parseInt(customerId));
        const customerName = customer ? customer.name : `Customer #${customerId}`;
        return `<li class="report-item"><span>${customerName}:</span><span>₹${totalSpent.toFixed(2)}</span></li>`;
    }).join('');

    // Inventory Report
    const { data: allProducts, error: productError } = await supabase.from('products').select('*');
    if (productError) {
        console.error('Failed to fetch product data:', productError);
        return;
    }

    const totalProductsCount = allProducts.length;
    const totalInventoryValue = allProducts.reduce((sum, product) => sum + (product.stock || 0) * (product.purchase_price || 0), 0);

    document.getElementById('totalProductsCount').textContent = totalProductsCount;
    document.getElementById('totalInventoryValue').textContent = `₹${totalInventoryValue.toFixed(2)}`;

    const stockLevelsList = document.getElementById('stockLevelsList');
    stockLevelsList.innerHTML = allProducts.sort((a, b) => (a.stock || 0) - (b.stock || 0)).map(product => `
        <li class="report-item">
            <span>${product.name}:</span>
            <span style="color:${product.stock > 10 ? 'green' : 'orange'};">${product.stock || 0} in stock</span>
        </li>
    `).join('');

    // Show all report sections
    document.querySelectorAll('.report-section').forEach(section => section.style.display = 'block');
}
// Call fetch functions on load (existing code)
    document.addEventListener('DOMContentLoaded', async function() {
      await Promise.all([
        fetchProducts(),
        fetchSuppliers(),
        fetchInvoices(),
        fetchExpenses(),
        fetchReturns(),
      ]);
      showTab('dashboard', document.querySelector('.nav-tab'));
    });

    function displayBestSellingProducts() {
      // Build a simple best-selling list from invoice_items (if invoices loaded)
      const counts = {};
      invoices.forEach(inv => {
        const items = inv.invoice_items || [];
        items.forEach(it => {
          counts[it.product_id] = (counts[it.product_id] || 0) + (it.quantity || 0);
        });
      });
      const arr = Object.entries(counts).map(([id, qty]) => ({ id, qty }));
      arr.sort((a,b) => b.qty - a.qty);
      const top5 = arr.slice(0,5).map(x => {
        const p = products.find(pp => pp.id === x.id);
        return { product: p, sold: x.qty };
      });

      const container = document.getElementById('best-selling-products');
      container.innerHTML = top5.map(x => x.product ? `
        <div class="product-card">
          ${x.product.image ? `<img src="${x.product.image}" alt="${x.product.name}">` : ''}
          <h4>${x.product.name}</h4>
          <p>Sold: ${x.sold}</p>
        </div>
      ` : '').join('');
    }
    // -------------------------
    // Barcode / Scanner helpers (kept basic)
    // -------------------------
   
let html5QrCode = null;

async function toggleScanner() {
    const scannerDiv = document.getElementById('reader');
    const startButton = document.getElementById('startScannerBtn');

    if (html5QrCode && html5QrCode.isScanning) {
        await html5QrCode.stop();
        scannerDiv.style.display = 'none';
        startButton.innerText = 'Start Scanner';
        return;
    }

    // Initialize scanner and show container
    scannerDiv.style.display = 'block';
    startButton.innerText = 'Stop Scanner';
    
    html5QrCode = new Html5Qrcode("reader");
    
    // Start scanning
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 700, height: 700 } },
        (decodedText, decodedResult) => {
            // Success callback when a barcode is scanned
            console.log(`Code matched = ${decodedText}`, decodedResult);
            document.getElementById('manualBarcode').value = decodedText;
            searchByBarcode();
            // Stop scanning after a successful scan
            html5QrCode.stop().then(() => {
                scannerDiv.style.display = 'none';
                startButton.innerText = 'Start Scanner';
            });
        },
        (errorMessage) => {
            // Optional: You can handle scan errors here if needed
        }
    ).catch(err => {
        console.error(`Failed to start scanner: ${err}`);
        alert("Failed to start scanner. Please ensure your website is using HTTPS and you have granted camera permission.");
        scannerDiv.style.display = 'none';
        startButton.innerText = 'Start Scanner';
    });
}

function searchByBarcode() {
  const barcode = document.getElementById('manualBarcode').value;
  const product = products.find(p => p.barcode === barcode);
  const result = document.getElementById('scannedResult');
  
  if (product) {
    result.innerHTML = `
      <div class="product-card">
        <h3>Product Found!</h3>
        ${product.image ? `<img src="${product.image}" alt="${product.name}">` : ''}
        <div class="barcode-container"><svg id="scanned-barcode" class="barcode-svg"></svg></div>
        <p><strong>Name:</strong> ${product.name}</p>
        <p><strong>Category:</strong> ${product.category}</p>
        <p><strong>Size:</strong> ${product.size || ''} | <strong>Color:</strong> ${product.color || ''}</p>
        <p><strong>Price:</strong> ₹${product.selling_price || 0}</p>
        <p><strong>Stock:</strong> ${product.quantity}</p>
        <button class="btn" onclick="addProductToInvoice('${product.id}')">➕ Add to Invoice</button>
        <button class="btn btn-info" onclick="printBarcode('scanned-barcode')">🖨️ Print Barcode</button>
      </div>
    `;
    try {
      JsBarcode("#scanned-barcode", product.barcode || '', { format: "CODE128", displayValue: true, lineColor: "#333", width:2, height:40, margin:10 });
    } catch (e) {}
  } else {
    result.innerHTML = `
      <div class="product-card" style="border:2px solid #ff6b6b;">
        <h3>Product Not Found</h3>
        <p>No product found with barcode: ${barcode}</p>
      </div>
    `;
  }
}
    // Add these functions to your existing <script> block

// -------------------------
// Export to Excel function
// -------------------------
function exportToExcel() {
    if (!products.length && !invoices.length && !expenses.length && !returnsArr.length && !suppliers.length) {
        alert('No data to export.');
        return;
    }

    const workbook = XLSX.utils.book_new();

    // 1. Products Sheet
    if (products.length > 0) {
        const productHeaders = [
            'ID',
            'Name',
            'Category',
            'Size',
            'Color',
            'Purchase Price',
            'Selling Price',
            'Quantity',
            'Supplier',
            'Barcode',
            'Date Added',
            'Min Stock Threshold'
        ];
        const productData = products.map(p => [
            p.id,
            p.name,
            p.category,
            p.size,
            p.color,
            p.purchase_price,
            p.selling_price,
            p.quantity,
            p.supplier,
            p.barcode,
            p.date_added,
            p.min_stock_quantity
        ]);
        const productSheet = XLSX.utils.aoa_to_sheet([productHeaders, ...productData]);
        XLSX.utils.book_append_sheet(workbook, productSheet, 'Products');
    }

    // 2. Invoices Sheet (with items)
    if (invoices.length > 0) {
        const invoiceHeaders = [
            'Invoice Number',
            'Date',
            'Total Amount',
            'Discount',
            'Subtotal'
        ];
        const invoiceData = invoices.map(i => [
            i.invoice_number,
            new Date(i.date).toLocaleDateString(),
            i.total,
            i.discount,
            i.subtotal
        ]);
        const invoiceSheet = XLSX.utils.aoa_to_sheet([invoiceHeaders, ...invoiceData]);
        XLSX.utils.book_append_sheet(workbook, invoiceSheet, 'Invoices');
    }

    // 3. Expenses Sheet
    if (expenses.length > 0) {
        const expenseHeaders = [
            'Date',
            'Category',
            'Description',
            'Amount'
        ];
        const expenseData = expenses.map(e => [
            e.date,
            e.category,
            e.description,
            e.amount
        ]);
        const expenseSheet = XLSX.utils.aoa_to_sheet([expenseHeaders, ...expenseData]);
        XLSX.utils.book_append_sheet(workbook, expenseSheet, 'Expenses');
    }

    // 4. Returns Sheet
    if (returnsArr.length > 0) {
        const returnsHeaders = [
            'Date',
            'Product Name',
            'Barcode',
            'Quantity',
            'Reason',
            'Credit Amount'
        ];
        const returnsData = returnsArr.map(r => [
            new Date(r.date).toLocaleDateString(),
            r.product_name,
            r.barcode,
            r.quantity,
            r.reason,
            r.credit_amount
        ]);
        const returnsSheet = XLSX.utils.aoa_to_sheet([returnsHeaders, ...returnsData]);
        XLSX.utils.book_append_sheet(workbook, returnsSheet, 'Returns');
    }
    
    // 5. Suppliers Sheet
    if (suppliers.length > 0) {
        const supplierHeaders = [
            'Name',
            'Contact Person',
            'Contact Info'
        ];
        const supplierData = suppliers.map(s => [
            s.name,
            s.contact_person,
            s.contact_info
        ]);
        const supplierSheet = XLSX.utils.aoa_to_sheet([supplierHeaders, ...supplierData]);
        XLSX.utils.book_append_sheet(workbook, supplierSheet, 'Suppliers');
    }

    // Generate and download the file
    XLSX.writeFile(workbook, 'Soniya_Dresses_Report.xlsx');
}

function importFromExcel() {
  document.getElementById('excelFile').click();
}

async function handleExcelImport(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(worksheet);

    if (json.length === 0) {
      alert("No data found in the Excel file.");
      return;
    }
    
    // Clear existing products and insert new ones
    if (confirm("This will replace all existing products. Are you sure?")) {
      const { error: deleteError } = await supabase.from('products').delete().neq('id', '00000000-0000-0000-0000-000000000000');
      if (deleteError) {
        alert("Failed to clear existing products.");
        return;
      }
      
      const { error: insertError } = await supabase.from('products').insert(json);
      if (insertError) {
        console.error('Import error:', insertError);
        alert('Failed to import products: ' + insertError.message);
      } else {
        alert('Products imported successfully!');
        await loadProducts();
      }
    }
  };
  reader.readAsArrayBuffer(file);
}

    function printBarcode(barcodeId) {
      const barcodeSvg = document.getElementById(barcodeId);
      if (barcodeSvg) {
        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>Print Barcode</title>');
        printWindow.document.write('<style>@media print{body{margin:0;padding:10mm;display:flex;justify-content:center;align-items:center;min-height:100vh;}svg{width:100%;height:auto;max-width:250px;}}</style>');
        printWindow.document.write('</head><body>');
      
  const clonedSvg = barcodeSvg.cloneNode(true);
  printWindow.document.body.appendChild(clonedSvg);
  printWindow.document.write("</body></html>");
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
         } else 
  alert('Barcode not found!');
}

    // -------------------------
    
    // -------------------------
    // Helpers & UI - Tabs, search etc
    // -------------------------
    function showTab(tabId) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
  // Show selected tab
  document.getElementById(tabId).style.display = 'block';
}

    function showTab(tabName, element) {
      const tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => tab.classList.remove('active'));
      const buttons = document.querySelectorAll('.nav-tab');
      buttons.forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      if (element) element.classList.add('active');

      if (tabName === 'inventory') displayInventory();
      if (tabName === 'alerts') displayLowStockAlerts();
      if (tabName === 'suppliers') displaySuppliers();
    }

    function searchInvoices(){ displayInvoices(); }

    // -------------------------
    // Barcode generator (same as original)
    // -------------------------
    function generateBarcode() {
      const timestamp = Date.now().toString();
      const random = Math.random().toString(36).substr(2,5).toUpperCase();
      return 'SD' + timestamp.slice(-6) + random;
    }

    // -------------------------
    // Init: load everything
    // -------------------------
    document.addEventListener('DOMContentLoaded', async function() {
      // Ensure user set SUPABASE_URL / SUPABASE_KEY
      if ('https://fmxrnqaauabwpgqibbgo.supabase.co' || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZteHJucWFhdWFid3BncWliYmdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTQxMjMsImV4cCI6MjA3MjEzMDEyM30.nSPmqoXZa4htX0_h7jOCW0XrHzomFbEZFkZSchvU7bk") {
    console.warn("⚠️ Please set SUPABASE_URL and SUPABASE_KEY at the top of the script.");
  }

  await loadProducts();
  await loadInvoices();
  await loadExpenses();
  await loadSuppliers();
  await loadReturns();

});

    // --- Notification System ---
    function showToast(type, title, message, duration = 5000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
            success: '✅',
            error: '❌',
            warning: '⚠️',
            info: 'ℹ️'
        };
        
        toast.innerHTML = `            <span class="toast-icon">${icons[type]}</span>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">×</button>
        `;
        
        toastContainer.appendChild(toast);
        
        // Auto-remove after duration
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }
        }, duration);
    }

    // --- Enhanced Form Validation ---
    function validateForm(formElement) {
        const inputs = formElement.querySelectorAll('input[required], select[required], textarea[required]');
        let isValid = true;
        
        inputs.forEach(input => {
            const formGroup = input.closest('.form-group-enhanced') || input.closest('.form-group');
            if (!input.value.trim()) {
                formGroup.classList.add('invalid');
                isValid = false;
            } else {
                formGroup.classList.remove('invalid');
                formGroup.classList.add('valid');
            }
        });
        
        return isValid;
    }

    // --- Auto-save Form Data ---
    function setupFormAutoSave(formId, fields) {
        const form = document.getElementById(formId);
        if (!form) return;
        
        fields.forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (field) {
                const savedValue = localStorage.getItem(`${formId}_${fieldName}`);
                if (savedValue) field.value = savedValue;
                
                field.addEventListener('input', () => {
                    localStorage.setItem(`${formId}_${fieldName}`, field.value);
                });
            }
        });
    }

    // --- Enhanced Search with Suggestions ---
    function setupEnhancedSearch(searchInputId, suggestionsContainerId, data, searchFields) {
        const searchInput = document.getElementById(searchInputId);
        const suggestionsContainer = document.getElementById(suggestionsContainerId);
        
        if (!searchInput || !suggestionsContainer) return;
        
        let recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
        
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            if (query.length < 2) {
                showRecentSearches();
                return;
            }
            
            const suggestions = data.filter(item => 
                searchFields.some(field => 
                    (item[field] || '').toLowerCase().includes(query)
                )
            ).slice(0, 8);
            
            showSuggestions(suggestions, query);
        });
        
        function showSuggestions(suggestions, query) {
            let html = '';
            
            if (suggestions.length > 0) {
                suggestions.forEach(item => {
                    const displayText = searchFields.map(field => item[field]).filter(Boolean).join(' - ');
                    html += `<div class="search-suggestion-item" onclick="selectSuggestion('${displayText}')">${displayText}</div>`;
                });
            } else {
                html = '<div class="search-suggestion-item">No results found</div>';
            }
            
            suggestionsContainer.innerHTML = html;
            suggestionsContainer.style.display = 'block';
        }
        
        function showRecentSearches() {
            if (recentSearches.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            let html = '<div class="recent-searches">Recent Searches</div>';
            recentSearches.forEach(search => {
                html += `<div class="search-suggestion-item" onclick="selectSuggestion('${search}')">${search}</div>`;
            });
            
            suggestionsContainer.innerHTML = html;
            suggestionsContainer.style.display = 'block';
        }
        
        function selectSuggestion(text) {
            searchInput.value = text;
            suggestionsContainer.style.display = 'none';
            
            // Add to recent searches
            recentSearches = [text, ...recentSearches.filter(s => s !== text)].slice(0, 5);
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
        }
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.style.display = 'none';
            }
        });
    }

    // --- Progress Ring Animation ---
    function animateProgressRing(elementId, percentage) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const circle = element.querySelector('.progress');
        if (circle) {
            const circumference = 2 * Math.PI * 25; // radius = 25
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        }
    }

    // --- Enhanced Tab Navigation with Breadcrumbs ---
    function updateBreadcrumbs(tabName) {
        const breadcrumbs = document.querySelector('.breadcrumbs');
        if (!breadcrumbs) return;
        
        const tabNames = {
            dashboard: 'Dashboard',
            products: 'Products',
            inventory: 'Inventory',
            billing: 'Billing',
            reports: 'Reports',
            about: 'About',
            alerts: 'Alerts',
            returns: 'Returns',
            suppliers: 'Suppliers',
            invoices: 'Invoice History',
            scanner: 'Scanner',
            expenses: 'Expenses'
        };
        
        breadcrumbs.innerHTML = `
            <div class="breadcrumb-item">
                <a href="#" class="breadcrumb-link" onclick="showTab('dashboard', document.querySelector('.nav-tab.active'))">Dashboard</a>
            </div>
            <div class="breadcrumb-item">
                <span class="breadcrumb-current">${tabNames[tabName] || tabName}</span>
            </div>
        `;
    }

    // --- Enhanced showTab function ---
    const originalShowTab = showTab;
    showTab = function(tabName, element) {
        originalShowTab(tabName, element);
        updateBreadcrumbs(tabName);
        
        // Add page transition effect
        const activeTab = document.querySelector('.tab-content.active');
        if (activeTab) {
            activeTab.style.animation = 'slideUp 0.4s ease-out';
        }
    };

    // --- Sidebar Toggle Function ---
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('show');
    }

    // --- Initialize Enhanced Features ---
    document.addEventListener('DOMContentLoaded', function() {
        // Setup form auto-save for product form
        setupFormAutoSave('productForm', ['productName', 'productCategory', 'productSize', 'productColor']);
        
        // Setup enhanced search for products
        setupEnhancedSearch('productSearch', 'productSuggestions', products, ['name', 'category', 'barcode']);
        
        // Show success toast on page load
        setTimeout(() => {
            showToast('success', 'Welcome!', 'Soniya Dresses system is ready');
        }, 1000);
});

    // End of script
    </script>
</body>
</html>

